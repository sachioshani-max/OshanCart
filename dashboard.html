<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Dashboard | Oshan Cart</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f4f7f6; margin: 0; display: flex; }
        .sidebar { width: 250px; background: #c9184a; height: 100vh; color: white; padding: 20px; position: fixed; }
        .main-content { margin-left: 270px; padding: 30px; width: calc(100% - 270px); }
        .card-container { display: flex; gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 15px; flex: 1; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid #c9184a; }
        .form-container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        
        /* Image Upload Box */
        .upload-box { border: 2px dashed #c9184a; padding: 30px; border-radius: 10px; cursor: pointer; background: #fff5f7; text-align: center; transition: 0.3s; }
        .upload-box:hover { background: #ffe0e6; }
        .upload-box i { font-size: 30px; color: #c9184a; margin-bottom: 10px; }
        
        .btn-post { background: #c9184a; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn-post:disabled { background: #ccc; }

        table { width: 100%; background: white; border-radius: 15px; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        .product-img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>OSHAN CART</h2>
        <p><i class="fas fa-th-large"></i> Dashboard</p>
        <p><i class="fas fa-box"></i> My Products</p>
        <p><i class="fas fa-sign-out-alt"></i> Logout</p>
    </div>

    <div class="main-content">
        <h1>Seller Dashboard</h1>
        
        <div class="card-container">
            <div class="card"><h3>Products</h3><p id="prod-count">0</p></div>
            <div class="card"><h3>Sales</h3><p>Rs. 0</p></div>
        </div>

        <div class="form-container">
            <h2 style="color: #c9184a;">Add New Product</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="input-group">
                    <label>Product Name</label>
                    <input type="text" id="p-name" placeholder="Item name...">
                </div>
                <div class="input-group">
                    <label>Price (Rs.)</label>
                    <input type="number" id="p-price" placeholder="1500">
                </div>
                <div class="input-group">
                    <label>Category</label>
                    <select id="p-cat">
                        <option>Fashion</option>
                        <option>Electronics</option>
                        <option>Jewelry</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Upload Image (JPG/PNG)</label>
                    <div class="upload-box" onclick="document.getElementById('p-file').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p id="file-status">Click to select photo</p>
                        <input type="file" id="p-file" accept="image/*" style="display: none;">
                    </div>
                </div>
            </div>
            <button class="btn-post" id="add-btn" onclick="addProduct()">List Product Now</button>
        </div>

        <h2>Your Items</h2>
        <table>
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="product-list"></tbody>
        </table>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDy430AP0t92QND_VdaoCkK0J23y2c5rkE",
        authDomain: "oshancart.firebaseapp.com",
        projectId: "oshancart",
        storageBucket: "oshancart.appspot.com",
        messagingSenderId: "686982543488",
        appId: "1:686982543488:web:d74a83a3f53dbae3754e65"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const IMGBB_KEY = "2e4966d15a568b4b2b8ab4d2515fb8b8";
    let selectedFile;

    // පින්තූරය තෝරාගත් විට
    document.getElementById('p-file').onchange = (e) => {
        selectedFile = e.target.files[0];
        document.getElementById('file-status').innerText = "Selected: " + selectedFile.name;
    };

    window.addProduct = async function() {
        const name = document.getElementById('p-name').value;
        const price = document.getElementById('p-price').value;
        const cat = document.getElementById('p-cat').value;
        const btn = document.getElementById('add-btn');

        if(name && price && selectedFile) {
            btn.innerText = "Uploading Image...";
            btn.disabled = true;

            try {
                // 1. Image එක ImgBB එකට යැවීම
                let formData = new FormData();
                formData.append("image", selectedFile);
                
                const imgResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                    method: "POST",
                    body: formData
                });
                const imgData = await imgResponse.json();
                const finalImageUrl = imgData.data.url;

                // 2. Firebase එකට දත්ත යැවීම
                await addDoc(collection(db, "products"), {
                    name: name,
                    price: parseFloat(price),
                    category: cat,
                    image: finalImageUrl,
                    createdAt: serverTimestamp(),
                    delivery: "Free Delivery",
                    brand: "Oshan Brand"
                });

                alert("භාණ්ඩය සාර්ථකව ඇතුළත් කළා!");
                location.reload();
            } catch (err) {
                alert("වැරදුනා: " + err.message);
                btn.disabled = false;
                btn.innerText = "List Product Now";
            }
        } else {
            alert("කරුණාකර සියලු විස්තර පුරවන්න.");
        }
    }

    // දත්ත පෙන්වීම
    async function loadItems() {
        const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        const list = document.getElementById('product-list');
        list.innerHTML = "";
        snapshot.forEach(doc => {
            const item = doc.data();
            list.innerHTML += `<tr>
                <td><img src="${item.image}" class="product-img"></td>
                <td>${item.name}</td>
                <td>Rs. ${item.price}</td>
                <td style="color: green;">Live</td>
            </tr>`;
        });
        document.getElementById('prod-count').innerText = snapshot.size;
    }
    loadItems();
</script>

</body>
</html>
